<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uzima Healthcare - Smart Triage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        
        details summary::-webkit-details-marker { display: none; }
        details[open] summary { border-bottom: 2px solid #a855f7; }
    </style>
</head>
<body class="bg-gradient-to-br from-teal-50 via-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-teal-600 to-blue-600 shadow-lg">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between flex-wrap">
                <div class="flex items-center">
                    <div class="bg-white rounded-full p-3 mr-4 shadow-lg">
                        <span class="text-4xl">üè•</span>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white">Uzima Healthcare</h1>
                        <p class="text-teal-100 text-sm font-medium">Smart Triage System</p>
                        <p class="text-teal-200 text-xs">Fast, Accurate, Comprehensive</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Impact Banner -->
    <div class="bg-gradient-to-r from-green-500 to-emerald-600 py-3">
        <div class="max-w-4xl mx-auto px-4">
            <div class="flex items-center justify-center gap-8 text-white text-sm font-semibold flex-wrap">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">‚ö°</span>
                    <span>2 Min Assessment</span>
                </div>
                <div class="flex items-center">
                    <span class="text-2xl mr-2">üë•</span>
                    <span>40% Wait Reduction</span>
                </div>
                <div class="flex items-center">
                    <span class="text-2xl mr-2">üòä</span>
                    <span>Better Care</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto px-4 py-8">
        
        <!-- Returning Patient Section -->
        <div id="returning-patient" class="mb-6 bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl shadow-lg p-6 border-2 border-purple-300">
            <div class="flex items-center mb-4">
                <span class="text-3xl mr-3">üëã</span>
                <div>
                    <p class="text-lg font-bold text-purple-900">Welcome Back!</p>
                    <p class="text-sm text-purple-700">Returning patient? Load your saved profile</p>
                </div>
            </div>
            <div class="flex gap-3">
                <input 
                    type="tel" 
                    id="returning-phone"
                    placeholder="+254712345678"
                    class="flex-1 px-4 py-3 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                />
                <button 
                    onclick="loadUserProfile()"
                    class="bg-purple-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-700 transition"
                >
                    üìÇ Load Profile
                </button>
            </div>
            <p class="text-xs text-purple-600 mt-2">üí° First time? Fill the form below and save your profile for next time!</p>
        </div>

        <!-- Demo Buttons -->
        <div id="demo-buttons" class="mb-6 bg-white rounded-xl shadow-lg p-6 border-t-4 border-teal-500">
            <div class="flex items-center mb-4">
                <span class="text-2xl mr-3">üéØ</span>
                <div>
                    <p class="text-lg font-bold text-gray-800">Quick Demo</p>
                    <p class="text-sm text-gray-600">See how Uzima routes different cases</p>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button onclick="loadDemo(0)" class="px-4 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:from-purple-600 hover:to-purple-700 transition font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                    <div class="text-2xl mb-1">üë©</div>
                    <div class="text-xs">UTI Case</div>
                </button>
                <button onclick="loadDemo(1)" class="px-4 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg hover:from-red-600 hover:to-red-700 transition font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                    <div class="text-2xl mb-1">üö®</div>
                    <div class="text-xs">Emergency</div>
                </button>
                <button onclick="loadDemo(2)" class="px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                    <div class="text-2xl mb-1">üè†</div>
                    <div class="text-xs">Self-Care</div>
                </button>
                <button onclick="loadDemo(3)" class="px-4 py-3 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-lg hover:from-yellow-600 hover:to-yellow-700 transition font-medium shadow-md hover:shadow-lg transform hover:scale-105">
                    <div class="text-2xl mb-1">üë®‚Äç‚öïÔ∏è</div>
                    <div class="text-xs">Complex</div>
                </button>
            </div>
        </div>

        <!-- Triage Form -->
        <div id="triage-form-container" class="bg-white rounded-xl shadow-xl p-8 fade-in border-t-4 border-teal-500">
            <div class="mb-6 text-center">
                <div class="inline-block bg-teal-100 rounded-full p-4 mb-4">
                    <span class="text-5xl">üìã</span>
                </div>
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Patient Assessment</h2>
                <p class="text-gray-600">Complete core fields in 2 minutes</p>
                <div class="mt-4 inline-block bg-blue-50 px-4 py-2 rounded-lg">
                    <p class="text-sm text-blue-800">‚è±Ô∏è Core: <strong>2 minutes</strong> | Optional: <strong>+1 minute</strong></p>
                </div>
            </div>

            <form id="triage-form" class="space-y-6">
                
                <!-- Fast Track Banner -->
                <div class="bg-gradient-to-r from-green-400 to-teal-500 text-white p-4 rounded-lg text-center">
                    <p class="font-bold text-lg">‚ö° Fast Track Triage</p>
                    <p class="text-sm">Answer core questions below | Optional details can be added after</p>
                </div>

                <!-- CORE FIELDS -->
                <div class="border-l-4 border-teal-600 pl-6 bg-teal-50 p-6 rounded-lg">
                    <h3 class="text-2xl font-bold text-teal-900 mb-6 flex items-center">
                        <span class="text-3xl mr-3">üè•</span>
                        Essential Information
                    </h3>
                    
                    <!-- Phone -->
                    <div class="mb-4">
                        <label for="phone" class="block text-sm font-semibold text-gray-700 mb-2">
                            üì± Phone Number *
                        </label>
                        <input 
                            type="tel" 
                            id="phone" 
                            name="phone"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"
                            placeholder="+254712345678"
                            required
                        />
                    </div>

                    <!-- Name and Age -->
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="patient-name" class="block text-sm font-semibold text-gray-700 mb-2">
                                üë§ Full Name *
                            </label>
                            <input 
                                type="text" 
                                id="patient-name" 
                                name="patient-name"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"
                                placeholder="e.g., Grace Wanjiru"
                                required
                            />
                        </div>
                        <div>
                            <label for="patient-age" class="block text-sm font-semibold text-gray-700 mb-2">
                                üéÇ Age *
                            </label>
                            <input 
                                type="number" 
                                id="patient-age" 
                                name="patient-age"
                                min="0"
                                max="120"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"
                                placeholder="e.g., 28"
                                required
                            />
                        </div>
                    </div>

                    <!-- Chief Complaint -->
                    <div class="mb-4">
                        <label for="chief-complaint" class="block text-sm font-semibold text-gray-700 mb-2">
                            üí¨ What brings you in today? *
                        </label>
                        <textarea 
                            id="chief-complaint" 
                            name="chief-complaint"
                            rows="4" 
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition"
                            placeholder="Describe your main symptom or concern..."
                            required
                        ></textarea>
                    </div>

                    <!-- Duration -->
                    <div class="mb-4">
                        <label for="duration" class="block text-sm font-semibold text-gray-700 mb-2">
                            üìÖ How long have you had these symptoms? *
                        </label>
                        <select 
                            id="duration" 
                            name="duration"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" 
                            required
                        >
                            <option value="" disabled selected>Select duration...</option>
                            <option value="less-than-1-hour">Less than 1 hour</option>
                            <option value="1-24-hours">1-24 hours</option>
                            <option value="1-7-days">1-7 days</option>
                            <option value="1-4-weeks">1-4 weeks</option>
                            <option value="more-than-1-month">More than 1 month</option>
                        </select>
                    </div>

                    <!-- Severity -->
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                            üìä Severity Rating *
                        </label>
                        <div class="grid grid-cols-3 gap-4">
                            <label class="cursor-pointer">
                                <input type="radio" name="severity" value="mild" class="peer hidden" required>
                                <div class="border-2 border-gray-300 peer-checked:border-green-500 peer-checked:bg-green-50 rounded-lg p-4 text-center transition hover:border-green-400">
                                    <div class="text-4xl mb-2">üòä</div>
                                    <div class="font-semibold text-green-700">Mild</div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="severity" value="moderate" class="peer hidden">
                                <div class="border-2 border-gray-300 peer-checked:border-yellow-500 peer-checked:bg-yellow-50 rounded-lg p-4 text-center transition hover:border-yellow-400">
                                    <div class="text-4xl mb-2">üòê</div>
                                    <div class="font-semibold text-yellow-700">Moderate</div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="severity" value="severe" class="peer hidden">
                                <div class="border-2 border-gray-300 peer-checked:border-red-500 peer-checked:bg-red-50 rounded-lg p-4 text-center transition hover:border-red-400">
                                    <div class="text-4xl mb-2">üò£</div>
                                    <div class="font-semibold text-red-700">Severe</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Red Flags -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">
                            ‚ö†Ô∏è Emergency Warning Signs *
                        </label>
                        <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4">
                            <div class="space-y-2">
                                <label class="flex items-center cursor-pointer hover:bg-red-100 p-2 rounded">
                                    <input type="checkbox" name="red-flags" value="chest-pain" class="mr-3 w-4 h-4">
                                    <span class="text-sm">üíî Chest pain or pressure</span>
                                </label>
                                <label class="flex items-center cursor-pointer hover:bg-red-100 p-2 rounded">
                                    <input type="checkbox" name="red-flags" value="breathing" class="mr-3 w-4 h-4">
                                    <span class="text-sm">üòÆ‚Äçüí® Severe difficulty breathing</span>
                                </label>
                                <label class="flex items-center cursor-pointer hover:bg-red-100 p-2 rounded">
                                    <input type="checkbox" name="red-flags" value="confusion" class="mr-3 w-4 h-4">
                                    <span class="text-sm">üòµ Confusion or altered consciousness</span>
                                </label>
                                <label class="flex items-center cursor-pointer hover:bg-red-100 p-2 rounded">
                                    <input type="checkbox" name="red-flags" value="bleeding" class="mr-3 w-4 h-4">
                                    <span class="text-sm">ü©∏ Severe bleeding</span>
                                </label>
                                <label class="flex items-center cursor-pointer hover:bg-red-100 p-2 rounded">
                                    <input type="checkbox" name="red-flags" value="high-fever" class="mr-3 w-4 h-4">
                                    <span class="text-sm">üå°Ô∏è Very high fever with confusion</span>
                                </label>
                                <label class="flex items-center cursor-pointer hover:bg-green-100 p-2 rounded border-t-2 border-green-200 mt-2 pt-2">
                                    <input type="checkbox" name="red-flags" value="none" class="mr-3 w-4 h-4">
                                    <span class="text-sm font-bold">‚úÖ None of these</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OPTIONAL FIELDS (Collapsible) -->
                <details class="border-2 border-purple-300 rounded-lg bg-purple-50 hover:bg-purple-100 transition">
                    <summary class="cursor-pointer p-6 font-bold text-purple-900 flex items-center justify-between select-none">
                        <span class="flex items-center">
                            <span class="text-2xl mr-3">‚ûï</span>
                            <span>Additional Medical Information (Optional)</span>
                        </span>
                        <span class="text-sm text-purple-600 font-normal">Click to expand ‚Ä¢ Helps improve care</span>
                    </summary>
                    
                    <div class="p-6 space-y-6 bg-white border-t-2 border-purple-200">
                        
                        <!-- Personal Details -->
                        <div class="border-l-4 border-purple-500 pl-4">
                            <h4 class="font-bold text-lg text-gray-800 mb-4">üìã Personal Details</h4>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label for="gender" class="block text-sm font-semibold text-gray-700 mb-2">Gender</label>
                                    <select id="gender" name="gender" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="">Select...</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="weight" class="block text-sm font-semibold text-gray-700 mb-2">Weight (kg)</label>
                                    <input type="number" id="weight" name="weight" step="0.1" placeholder="65" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label for="height" class="block text-sm font-semibold text-gray-700 mb-2">Height (cm)</label>
                                    <input type="number" id="height" name="height" step="0.1" placeholder="165" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="location" class="block text-sm font-semibold text-gray-700 mb-2">County/Location</label>
                                <input type="text" id="location" name="location" placeholder="e.g., Nairobi" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>

                        <!-- Medical History -->
                        <div class="border-l-4 border-blue-500 pl-4">
                            <h4 class="font-bold text-lg text-gray-800 mb-4">üè• Medical History</h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="allergies" class="block text-sm font-semibold text-gray-700 mb-2">Known Allergies</label>
                                    <textarea id="allergies" name="allergies" rows="2" placeholder="e.g., Penicillin, Peanuts" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                                <div>
                                    <label for="medications" class="block text-sm font-semibold text-gray-700 mb-2">Current Medications</label>
                                    <textarea id="medications" name="medications" rows="2" placeholder="List any medications you're taking" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Travel History (Last 14 Days)</label>
                                    <div class="flex gap-4 flex-wrap">
                                        <label class="flex items-center">
                                            <input type="radio" name="travel" value="no" class="mr-2" checked> 
                                            <span class="text-sm">No travel</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="travel" value="domestic" class="mr-2"> 
                                            <span class="text-sm">Domestic</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="travel" value="international" class="mr-2"> 
                                            <span class="text-sm">International</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Symptom Details -->
                        <div class="border-l-4 border-green-500 pl-4">
                            <h4 class="font-bold text-lg text-gray-800 mb-4">ü©∫ Symptom Details</h4>
                            <div>
                                <label for="body-location" class="block text-sm font-semibold text-gray-700 mb-2">Body Location</label>
                                <select id="body-location" name="body-location" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="">Select area...</option>
                                    <option value="head">Head/Face</option>
                                    <option value="neck">Neck</option>
                                    <option value="chest">Chest</option>
                                    <option value="abdomen">Abdomen/Stomach</option>
                                    <option value="back">Back</option>
                                    <option value="arms">Arms/Hands</option>
                                    <option value="legs">Legs/Feet</option>
                                    <option value="skin">Skin (general)</option>
                                    <option value="multiple">Multiple areas</option>
                                    <option value="general">General/Whole body</option>
                                </select>
                            </div>
                        </div>

                    </div>
                </details>

                <!-- Submit Button -->
                <button 
                    type="submit" 
                    id="submit-btn"
                    class="w-full bg-gradient-to-r from-teal-600 to-blue-600 text-white py-4 px-6 rounded-lg font-bold text-lg hover:from-teal-700 hover:to-blue-700 transition transform hover:scale-105 shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span class="flex items-center justify-center">
                        <span class="text-2xl mr-3">üîç</span>
                        <span>Get Care Recommendation</span>
                    </span>
                </button>
            </form>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden"></div>
        
    </div>

    <!-- Footer -->
    <div class="bg-gradient-to-r from-teal-600 to-blue-600 mt-12 py-8">
        <div class="max-w-4xl mx-auto px-4 text-center text-white">
            <div class="mb-4">
                <div class="inline-block bg-white rounded-full p-3 mb-2">
                    <span class="text-3xl">üè•</span>
                </div>
                <h3 class="text-2xl font-bold">Uzima Healthcare</h3>
                <p class="text-teal-100 text-sm">Fast, Smart, Comprehensive Triage</p>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCuIJN_dMJyutgBM-WjSRtHvGcqECfd73E",
            authDomain: "uzima-healthcare.firebaseapp.com",
            projectId: "uzima-healthcare",
            storageBucket: "uzima-healthcare.firebasestorage.app",
            messagingSenderId: "7640251385",
            appId: "1:7640251385:web:f40a7d601e68b7aa255b28"
        };

        // Initialize Firebase
        let db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('‚úÖ Firebase initialized');
        } catch (error) {
            console.error('‚ùå Firebase error:', error);
        }

        // Demo Data
        const demoPatients = [
            {
                phone: "+254712345678", name: "Grace Wanjiru", age: "28", gender: "female",
                weight: "65", height: "165", location: "Nairobi", allergies: "None",
                medications: "None", travel: "no",
                chiefComplaint: "Burning sensation when urinating, frequent urge to urinate, lower abdominal discomfort",
                bodyLocation: "abdomen", duration: "1-7-days", severity: "moderate", redFlags: ["none"]
            },
            {
                phone: "+254723456789", name: "John Kamau", age: "65", gender: "male",
                weight: "78", height: "172", location: "Nairobi", allergies: "None",
                medications: "Aspirin daily", travel: "no",
                chiefComplaint: "Severe chest pain radiating to left arm, shortness of breath, heavy sweating, nausea",
                bodyLocation: "chest", duration: "less-than-1-hour", severity: "severe", redFlags: ["chest-pain", "breathing"]
            },
            {
                phone: "+254734567890", name: "Mary Achieng", age: "32", gender: "female",
                weight: "60", height: "160", location: "Kisumu", allergies: "Peanuts",
                medications: "None", travel: "no",
                chiefComplaint: "Mild headache, runny nose, slight cough, feeling tired",
                bodyLocation: "head", duration: "1-24-hours", severity: "mild", redFlags: ["none"]
            },
            {
                phone: "+254745678901", name: "Peter Ochieng", age: "45", gender: "male",
                weight: "72", height: "175", location: "Mombasa", allergies: "None",
                medications: "None", travel: "international",
                chiefComplaint: "Persistent cough for 3 weeks, night sweats, unexplained weight loss, fatigue",
                bodyLocation: "chest", duration: "1-4-weeks", severity: "moderate", redFlags: ["none"]
            }
        ];

        function loadDemo(index) {
            const p = demoPatients[index];
            document.getElementById('phone').value = p.phone;
            document.getElementById('patient-name').value = p.name;
            document.getElementById('patient-age').value = p.age;
            document.getElementById('chief-complaint').value = p.chiefComplaint;
            document.getElementById('duration').value = p.duration;
            document.querySelector(`input[name="severity"][value="${p.severity}"]`).checked = true;
            
            // Optional fields
            if (p.gender) document.getElementById('gender').value = p.gender;
            if (p.weight) document.getElementById('weight').value = p.weight;
            if (p.height) document.getElementById('height').value = p.height;
            if (p.location) document.getElementById('location').value = p.location;
            if (p.allergies) document.getElementById('allergies').value = p.allergies;
            if (p.medications) document.getElementById('medications').value = p.medications;
            document.querySelector(`input[name="travel"][value="${p.travel}"]`).checked = true;
            if (p.bodyLocation) document.getElementById('body-location').value = p.bodyLocation;
            
            document.querySelectorAll('input[name="red-flags"]').forEach(cb => cb.checked = false);
            p.redFlags.forEach(flag => {
                const checkbox = document.querySelector(`input[name="red-flags"][value="${flag}"]`);
                if (checkbox) checkbox.checked = true;
            });

            document.getElementById('triage-form-container').scrollIntoView({ behavior: 'smooth' });
        }

        // Load User Profile
        async function loadUserProfile() {
            const phone = document.getElementById('returning-phone').value;
            if (!phone) {
                alert('Please enter your phone number');
                return;
            }

            try {
                const snapshot = await db.collection('user_profiles').where('phone', '==', phone).limit(1).get();
                if (snapshot.empty) {
                    alert('No profile found for this number. Please fill the form below to create one!');
                    return;
                }

                const profile = snapshot.docs[0].data();
                
                // Fill in saved data
                document.getElementById('phone').value = profile.phone;
                document.getElementById('patient-name').value = profile.name;
                document.getElementById('patient-age').value = profile.age;
                if (profile.gender) document.getElementById('gender').value = profile.gender;
                if (profile.weight) document.getElementById('weight').value = profile.weight;
                if (profile.height) document.getElementById('height').value = profile.height;
                if (profile.location) document.getElementById('location').value = profile.location;
                if (profile.allergies) document.getElementById('allergies').value = profile.allergies;
                if (profile.medications) document.getElementById('medications').value = profile.medications;
                
                // Scroll to form
                document.getElementById('triage-form-container').scrollIntoView({ behavior: 'smooth' });
                
                // Show success message
                alert('‚úÖ Profile loaded! Just fill in your current symptoms and submit.');
                
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Error loading profile. Please try again.');
            }
        }

        // Save User Profile
        async function saveUserProfile(formData) {
            try {
                const profileData = {
                    phone: formData.phone,
                    name: formData.name,
                    age: formData.age,
                    gender: formData.gender || null,
                    weight: formData.weight || null,
                    height: formData.height || null,
                    location: formData.location || null,
                    allergies: formData.allergies || 'None',
                    medications: formData.medications || 'None',
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Check if profile exists
                const existing = await db.collection('user_profiles').where('phone', '==', formData.phone).limit(1).get();
                
                if (existing.empty) {
                    // Create new profile
                    await db.collection('user_profiles').add(profileData);
                    console.log('‚úÖ Profile created');
                    return true;
                } else {
                    // Update existing profile
                    await db.collection('user_profiles').doc(existing.docs[0].id).update(profileData);
                    console.log('‚úÖ Profile updated');
                    return false; // Not new
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                return null;
            }
        }

        // Triage Logic
        function triagePatient(formData) {
            const { chiefComplaint, duration, severity, redFlags } = formData;
            const complaint = chiefComplaint.toLowerCase();
            
            const dangerousFlags = redFlags.filter(flag => flag !== 'none');
            if (dangerousFlags.length > 0) {
                return {
                    level: 'EMERGENCY', priority: 1, color: 'RED', icon: 'üö®',
                    action: 'Go to Emergency Department IMMEDIATELY', waitTime: 'IMMEDIATE',
                    provider: 'Emergency Physician',
                    reasoning: 'Life-threatening symptoms detected.',
                    instructions: ['Call 999 or go to Emergency NOW', 'Do NOT wait', 'Inform staff immediately']
                };
            }
            
            const nurseKeywords = ['uti', 'urinary', 'burning', 'refill', 'blood pressure', 'diabetes'];
            if (nurseKeywords.some(k => complaint.includes(k)) && (severity === 'mild' || severity === 'moderate')) {
                return {
                    level: 'NURSE CONSULTATION', priority: 3, color: 'GREEN', icon: 'üë©‚Äç‚öïÔ∏è',
                    action: 'See nurse or clinical officer', waitTime: '15-20 minutes',
                    provider: 'Clinical Nurse/Officer',
                    reasoning: 'Your condition can be managed by nursing staff.',
                    instructions: ['Check in at nurse station', 'Show your reference number', 'Nurse will assess and treat']
                };
            }
            
            const selfCareKeywords = ['cold', 'runny nose', 'mild headache', 'slight cough'];
            const isRecent = duration === '1-24-hours' || duration === 'less-than-1-hour';
            if (selfCareKeywords.some(k => complaint.includes(k)) && severity === 'mild' && isRecent) {
                return {
                    level: 'SELF-CARE', priority: 4, color: 'BLUE', icon: 'üè†',
                    action: 'Home care recommended', waitTime: 'No clinic visit needed',
                    provider: 'Self-management',
                    reasoning: 'Symptoms are mild and recent. Try home care first.',
                    instructions: ['Get plenty of rest', 'Stay hydrated', 'Over-the-counter pain relief if needed', 'Call clinic if symptoms worsen']
                };
            }
            
            return {
                level: 'PHYSICIAN CONSULTATION', priority: 2, color: 'YELLOW', icon: 'üë®‚Äç‚öïÔ∏è',
                action: 'See medical doctor', waitTime: '30-40 minutes',
                provider: 'Medical Doctor',
                reasoning: 'Your symptoms require physician evaluation.',
                instructions: ['Check in at reception', 'Doctor will examine you', 'Tests may be ordered', 'Treatment plan will be provided']
            };
        }

        // Form submission
        document.getElementById('triage-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="flex items-center justify-center"><span class="animate-spin mr-3">‚è≥</span><span>Processing...</span></span>';
            
            const formData = {
                phone: document.getElementById('phone').value,
                name: document.getElementById('patient-name').value,
                age: document.getElementById('patient-age').value,
                gender: document.getElementById('gender').value || null,
                weight: document.getElementById('weight').value || null,
                height: document.getElementById('height').value || null,
                location: document.getElementById('location').value || null,
                allergies: document.getElementById('allergies').value || 'None',
                medications: document.getElementById('medications').value || 'None',
                travel: document.querySelector('input[name="travel"]:checked').value,
                chiefComplaint: document.getElementById('chief-complaint').value,
                bodyLocation: document.getElementById('body-location').value || 'Not specified',
                duration: document.getElementById('duration').value,
                severity: document.querySelector('input[name="severity"]:checked').value,
                redFlags: Array.from(document.querySelectorAll('input[name="red-flags"]:checked')).map(cb => cb.value),
                source: 'web',
                timestamp: new Date().toISOString()
            };
            
            const triageResult = triagePatient(formData);
            
            try {
                const refId = 'WEB' + Date.now().toString().slice(-8);
                
                // Save assessment
                if (db !== null) {
                    await db.collection('assessments').add({
                        ...formData,
                        triageLevel: triageResult.level,
                        triageAction: triageResult.action,
                        triagePriority: triageResult.priority,
                        triageColor: triageResult.color,
                        expectedWait: triageResult.waitTime,
                        provider: triageResult.provider,
                        reasoning: triageResult.reasoning,
                        instructions: triageResult.instructions,
                        status: 'waiting',
                        queueNumber: generateQueueNumber(triageResult.priority),
                        refId: refId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úÖ Assessment saved');
                    
                    // Save/update user profile
                    const isNewProfile = await saveUserProfile(formData);
                    formData.isNewProfile = isNewProfile;
                }
                
                displayResult(triageResult, formData, refId);
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                const refId = 'WEB' + Date.now().toString().slice(-8);
                displayResult(triageResult, formData, refId);
            }
        });

        function generateQueueNumber(priority) {
            const prefix = { 1: 'E', 2: 'D', 3: 'N', 4: 'S' };
            const number = Math.floor(Math.random() * 999) + 1;
            return `${prefix[priority]}${number.toString().padStart(3, '0')}`;
        }

        function displayResult(result, formData, refId) {
            const resultsDiv = document.getElementById('results');
            const formDiv = document.getElementById('triage-form-container');
            const demoButtons = document.getElementById('demo-buttons');
            const returningSection = document.getElementById('returning-patient');
            
            formDiv.classList.add('hidden');
            demoButtons.classList.add('hidden');
            returningSection.classList.add('hidden');
            resultsDiv.classList.remove('hidden');
            resultsDiv.classList.add('fade-in');
            
            const colorMap = {
                'RED': { bg: 'bg-red-100', border: 'border-red-500', text: 'text-red-900', badge: 'bg-red-600' },
                'YELLOW': { bg: 'bg-yellow-100', border: 'border-yellow-500', text: 'text-yellow-900', badge: 'bg-yellow-600' },
                'GREEN': { bg: 'bg-green-100', border: 'border-green-500', text: 'text-green-900', badge: 'bg-green-600' },
                'BLUE': { bg: 'bg-blue-100', border: 'border-blue-500', text: 'text-blue-900', badge: 'bg-blue-600' }
            };
            
            const colors = colorMap[result.color];
            const queueNum = generateQueueNumber(result.priority);
            
            // Profile save notification
            let profileNotification = '';
            if (formData.isNewProfile === true) {
                profileNotification = `
                    <div class="bg-green-100 border-2 border-green-500 p-4 rounded-lg mb-6 text-center">
                        <p class="text-green-900 font-bold">‚úÖ Profile Saved!</p>
                        <p class="text-sm text-green-700">Next time, just enter your phone number to load your info instantly!</p>
                    </div>
                `;
            } else if (formData.isNewProfile === false) {
                profileNotification = `
                    <div class="bg-blue-100 border-2 border-blue-500 p-4 rounded-lg mb-6 text-center">
                        <p class="text-blue-900 font-bold">üîÑ Profile Updated!</p>
                        <p class="text-sm text-blue-700">Your information has been updated in our system.</p>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-8 mb-6 border-t-8 ${colors.border}">
                    
                    ${profileNotification}
                    
                    <!-- Queue Position -->
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6 rounded-xl mb-6 text-center">
                        <div class="text-sm font-semibold mb-2">YOUR QUEUE POSITION</div>
                        <div class="text-5xl font-bold mb-2">${queueNum}</div>
                        <div class="text-lg font-semibold mt-2">Estimated wait: ${result.waitTime}</div>
                    </div>

                    <!-- Triage Result -->
                    <div class="${colors.bg} p-6 rounded-xl mb-6 border-2 ${colors.border}">
                        <div class="flex items-center mb-4">
                            <span class="text-6xl mr-4">${result.icon}</span>
                            <div>
                                <h2 class="text-3xl font-bold ${colors.text}">${result.action}</h2>
                                <span class="${colors.badge} text-white px-4 py-2 rounded-full text-sm font-bold inline-block mt-2">
                                    ${result.level}
                                </span>
                            </div>
                        </div>
                        <p class="text-lg ${colors.text} mb-4">${result.reasoning}</p>
                    </div>

                    <!-- Emergency Resources -->
                    <div class="bg-red-50 border-l-4 border-red-600 p-6 rounded-lg mb-6">
                        <h3 class="text-2xl font-bold text-red-900 mb-4 flex items-center">
                            <span class="text-3xl mr-3">üö®</span>
                            Emergency Resources
                        </h3>
                        
                        <div class="bg-white p-4 rounded-lg mb-4">
                            <h4 class="font-bold text-lg mb-3 text-gray-800">üìû Kenya Emergency Hotlines</h4>
                            <div class="grid md:grid-cols-2 gap-3">
                                <a href="tel:999" class="flex items-center justify-between bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transition">
                                    <span class="font-semibold">üö® Emergency</span>
                                    <span class="text-xl font-bold">999</span>
                                </a>
                                <a href="tel:+254202272763" class="flex items-center justify-between bg-orange-600 text-white p-3 rounded-lg hover:bg-orange-700 transition">
                                    <span class="font-semibold text-sm">üöë Ambulance</span>
                                    <span class="text-sm font-bold">0202272763</span>
                                </a>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg">
                            <h4 class="font-bold text-lg mb-3 text-gray-800">üè• Major Nairobi Hospitals</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between items-center p-2 bg-teal-50 rounded">
                                    <span class="font-semibold">Kenyatta National Hospital</span>
                                    <a href="tel:+254202726300" class="bg-teal-600 text-white px-3 py-1 rounded text-xs hover:bg-teal-700">Call</a>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-blue-50 rounded">
                                    <span class="font-semibold">Nairobi Hospital</span>
                                    <a href="tel:+254202845000" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">Call</a>
                                </div>
                                <div class="flex justify-between items-center p-2 bg-green-50 rounded">
                                    <span class="font-semibold">Aga Khan Hospital</span>
                                    <a href="tel:+254203662000" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">Call</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Next Steps -->
                    <div class="bg-indigo-50 p-6 rounded-xl mb-6">
                        <h3 class="text-xl font-bold mb-4">üìã Next Steps</h3>
                        <ul class="space-y-2">
                            ${result.instructions.map(step => `
                                <li class="flex items-start">
                                    <span class="text-indigo-600 mr-2">‚Üí</span>
                                    <span>${step}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>

                    <!-- Assessment Summary -->
                    <div class="bg-gray-50 p-6 rounded-xl mb-6">
                        <h3 class="text-xl font-bold mb-4">üìä Assessment Summary</h3>
                        <div class="grid md:grid-cols-2 gap-3 text-sm">
                            <div><strong>Reference:</strong> ${refId}</div>
                            <div><strong>Queue:</strong> ${queueNum}</div>
                            <div><strong>Name:</strong> ${formData.name}</div>
                            <div><strong>Age:</strong> ${formData.age}</div>
                            <div><strong>Phone:</strong> ${formData.phone}</div>
                            ${formData.gender ? `<div><strong>Gender:</strong> ${formData.gender}</div>` : ''}
                            ${formData.location ? `<div><strong>Location:</strong> ${formData.location}</div>` : ''}
                            <div class="md:col-span-2"><strong>Symptoms:</strong> ${formData.chiefComplaint}</div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <button onclick="resetForm()" class="bg-gray-600 text-white py-3 rounded-lg font-bold hover:bg-gray-700 transition">
                            ‚Üê Assess Another Patient
                        </button>
                        <button onclick="window.print()" class="bg-teal-600 text-white py-3 rounded-lg font-bold hover:bg-teal-700 transition">
                            üñ®Ô∏è Print Summary
                        </button>
                    </div>
                </div>
            `;

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('triage-form-container').classList.remove('hidden');
            document.getElementById('demo-buttons').classList.remove('hidden');
            document.getElementById('returning-patient').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('triage-form').reset();
            document.getElementById('submit-btn').disabled = false;
            document.getElementById('submit-btn').innerHTML = '<span class="flex items-center justify-center"><span class="text-2xl mr-3">üîç</span><span>Get Care Recommendation</span></span>';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Prevent "none" checkbox conflict
        document.querySelectorAll('input[name="red-flags"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.value === 'none' && this.checked) {
                    document.querySelectorAll('input[name="red-flags"]').forEach(cb => {
                        if (cb.value !== 'none') cb.checked = false;
                    });
                } else if (this.value !== 'none' && this.checked) {
                    document.querySelector('input[name="red-flags"][value="none"]').checked = false;
                }
            });
        });
    </script>
</body>
</html>