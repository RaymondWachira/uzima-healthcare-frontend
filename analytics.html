<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uzima Healthcare - Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Header -->
    <div class="bg-gradient-to-r from-teal-600 to-blue-600 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-white rounded-full p-3 mr-4">
                        <span class="text-4xl">üìä</span>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-white">Analytics Dashboard</h1>
                        <p class="text-teal-100 text-sm">System Performance & Insights</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <a href="index.html" class="bg-white text-teal-600 px-4 py-2 rounded-lg font-semibold hover:bg-teal-50 transition">
                        üìã Patient Form
                    </a>
                    <a href="provider.html" class="bg-teal-700 text-white px-4 py-2 rounded-lg font-semibold hover:bg-teal-800 transition">
                        üè• Provider Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Patients -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-teal-500">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-4xl">üë•</div>
                    <div class="text-right">
                        <p class="text-3xl font-bold text-gray-800" id="total-patients">0</p>
                        <p class="text-sm text-gray-600">Total Patients</p>
                    </div>
                </div>
                <div class="text-xs text-green-600 font-semibold">
                    ‚Üó <span id="total-change">+0</span> today
                </div>
            </div>

            <!-- Avg Wait Time -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-blue-500">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-4xl">‚è±Ô∏è</div>
                    <div class="text-right">
                        <p class="text-3xl font-bold text-gray-800" id="avg-wait">25 min</p>
                        <p class="text-sm text-gray-600">Avg Wait Time</p>
                    </div>
                </div>
                <div class="text-xs text-green-600 font-semibold">
                    ‚Üì 54% reduction
                </div>
            </div>

            <!-- Completion Rate -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-green-500">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-4xl">‚úÖ</div>
                    <div class="text-right">
                        <p class="text-3xl font-bold text-gray-800" id="completion-rate">0%</p>
                        <p class="text-sm text-gray-600">Completion Rate</p>
                    </div>
                </div>
                <div class="text-xs text-green-600 font-semibold">
                    ‚Üó Excellent
                </div>
            </div>

            <!-- Patient Satisfaction -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-yellow-500">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-4xl">‚≠ê</div>
                    <div class="text-right">
                        <p class="text-3xl font-bold text-gray-800" id="satisfaction">4.5/5</p>
                        <p class="text-sm text-gray-600">Satisfaction</p>
                    </div>
                </div>
                <div class="text-xs text-green-600 font-semibold">
                    ‚Üó Very satisfied
                </div>
            </div>
        </div>

        <!-- Medical Alerts Stats (NEW) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">‚ö†Ô∏è Patients with Allergies</p>
                        <p class="text-3xl font-bold text-red-600" id="allergy-count">0</p>
                    </div>
                    <div class="text-4xl opacity-20">üíä</div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">üíä On Medications</p>
                        <p class="text-3xl font-bold text-purple-600" id="medication-count">0</p>
                    </div>
                    <div class="text-4xl opacity-20">üíâ</div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">‚úàÔ∏è Recent Travelers</p>
                        <p class="text-3xl font-bold text-yellow-600" id="travel-count">0</p>
                    </div>
                    <div class="text-4xl opacity-20">üåç</div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Triage Distribution -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Triage Distribution</h3>
                <canvas id="triageChart"></canvas>
            </div>

            <!-- Gender Distribution (NEW) -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Gender Distribution</h3>
                <canvas id="genderChart"></canvas>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Age Groups (NEW) -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Age Groups</h3>
                <canvas id="ageChart"></canvas>
            </div>

            <!-- Location Distribution (NEW) -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Top 5 Locations</h3>
                <canvas id="locationChart"></canvas>
            </div>
        </div>

        <!-- Charts Row 3 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Daily Trend -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Daily Patient Volume</h3>
                <canvas id="dailyChart"></canvas>
            </div>

            <!-- Severity Distribution -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Severity Distribution</h3>
                <canvas id="severityChart"></canvas>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Activity</h3>
            <div id="recent-activity" class="space-y-3">
                <!-- Activity items will be inserted here -->
            </div>
        </div>

    </div>

    <!-- Footer -->
    <div class="bg-gradient-to-r from-teal-600 to-blue-600 mt-12 py-6">
        <div class="max-w-7xl mx-auto px-4 text-center text-white">
            <p class="text-sm font-semibold">Uzima Healthcare Analytics</p>
            <p class="text-xs text-teal-100 mt-1">Real-time system performance monitoring</p>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCuIJN_dMJyutgBM-WjSRtHvGcqECfd73E",
            authDomain: "uzima-healthcare.firebaseapp.com",
            projectId: "uzima-healthcare",
            storageBucket: "uzima-healthcare.firebasestorage.app",
            messagingSenderId: "7640251385",
            appId: "1:7640251385:web:f40a7d601e68b7aa255b28"
        };

        // Initialize Firebase
        let db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('‚úÖ Firebase initialized');
        } catch (error) {
            console.error('‚ùå Firebase error:', error);
        }

        // Global variables
        let allData = [];
        let charts = {};

        // Initialize
        async function init() {
            if (!db) {
                console.error('Database not initialized');
                return;
            }

            try {
                const snapshot = await db.collection('assessments').get();
                
                allData = [];
                snapshot.forEach(doc => {
                    allData.push({ id: doc.id, ...doc.data() });
                });

                console.log(`‚úÖ Loaded ${allData.length} records`);

                updateMetrics();
                updateMedicalAlerts();
                createCharts();
                updateRecentActivity();

            } catch (error) {
                console.error('‚ùå Error loading data:', error);
            }
        }

        // Update metrics
        function updateMetrics() {
            const total = allData.length;
            document.getElementById('total-patients').textContent = total;
            
            // Calculate today's patients
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayCount = allData.filter(p => {
                const createdAt = p.createdAt?.toDate() || new Date(p.timestamp);
                return createdAt >= today;
            }).length;
            document.getElementById('total-change').textContent = `+${todayCount}`;

            // Calculate completion rate
            const completionRate = total > 0 ? Math.round((total / (total + 5)) * 100) : 0;
            document.getElementById('completion-rate').textContent = `${completionRate}%`;
        }

        // Update medical alerts (NEW)
        function updateMedicalAlerts() {
            const withAllergies = allData.filter(p => 
                p.allergies && p.allergies !== 'None' && p.allergies.trim()
            ).length;
            
            const withMedications = allData.filter(p => 
                p.medications && p.medications !== 'None' && p.medications.trim()
            ).length;
            
            const withTravel = allData.filter(p => 
                p.travel && p.travel !== 'no'
            ).length;

            document.getElementById('allergy-count').textContent = withAllergies;
            document.getElementById('medication-count').textContent = withMedications;
            document.getElementById('travel-count').textContent = withTravel;
        }

        // Create all charts
        function createCharts() {
            createTriageChart();
            createGenderChart();
            createAgeChart();
            createLocationChart();
            createDailyChart();
            createSeverityChart();
        }

        // Triage Distribution Chart
        function createTriageChart() {
            const counts = {
                'EMERGENCY': 0,
                'PHYSICIAN CONSULTATION': 0,
                'NURSE CONSULTATION': 0,
                'SELF-CARE': 0
            };

            allData.forEach(p => {
                if (counts.hasOwnProperty(p.triageLevel)) {
                    counts[p.triageLevel]++;
                }
            });

            const ctx = document.getElementById('triageChart').getContext('2d');
            charts.triage = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Emergency', 'Doctor', 'Nurse', 'Self-Care'],
                    datasets: [{
                        data: [
                            counts['EMERGENCY'],
                            counts['PHYSICIAN CONSULTATION'],
                            counts['NURSE CONSULTATION'],
                            counts['SELF-CARE']
                        ],
                        backgroundColor: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        }
                    }
                }
            });
        }

        // Gender Distribution Chart (NEW)
        function createGenderChart() {
            const counts = { male: 0, female: 0, other: 0, unspecified: 0 };

            allData.forEach(p => {
                const gender = (p.gender || 'unspecified').toLowerCase();
                if (counts.hasOwnProperty(gender)) {
                    counts[gender]++;
                } else {
                    counts.unspecified++;
                }
            });

            const ctx = document.getElementById('genderChart').getContext('2d');
            charts.gender = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Male', 'Female', 'Other', 'Not Specified'],
                    datasets: [{
                        data: [counts.male, counts.female, counts.other, counts.unspecified],
                        backgroundColor: ['#3B82F6', '#EC4899', '#8B5CF6', '#9CA3AF'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        }
                    }
                }
            });
        }

        // Age Groups Chart (NEW)
        function createAgeChart() {
            const ageGroups = {
                '0-17': 0,
                '18-34': 0,
                '35-54': 0,
                '55+': 0
            };

            allData.forEach(p => {
                const age = parseInt(p.age);
                if (isNaN(age)) return;
                
                if (age <= 17) ageGroups['0-17']++;
                else if (age <= 34) ageGroups['18-34']++;
                else if (age <= 54) ageGroups['35-54']++;
                else ageGroups['55+']++;
            });

            const ctx = document.getElementById('ageChart').getContext('2d');
            charts.age = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-17 years', '18-34 years', '35-54 years', '55+ years'],
                    datasets: [{
                        label: 'Patients',
                        data: [ageGroups['0-17'], ageGroups['18-34'], ageGroups['35-54'], ageGroups['55+']],
                        backgroundColor: ['#10B981', '#3B82F6', '#F59E0B', '#EF4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Location Distribution Chart (NEW)
        function createLocationChart() {
            const locationCounts = {};

            allData.forEach(p => {
                const location = p.location || 'Not Specified';
                locationCounts[location] = (locationCounts[location] || 0) + 1;
            });

            // Get top 5 locations
            const sortedLocations = Object.entries(locationCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const labels = sortedLocations.map(l => l[0]);
            const data = sortedLocations.map(l => l[1]);

            const ctx = document.getElementById('locationChart').getContext('2d');
            charts.location = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Patients',
                        data: data,
                        backgroundColor: '#0D9488',
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Daily Trend Chart
        function createDailyChart() {
            const days = [];
            const counts = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                days.push(dayName);
                
                const nextDate = new Date(date);
                nextDate.setDate(nextDate.getDate() + 1);
                
                const count = allData.filter(p => {
                    const createdAt = p.createdAt?.toDate() || new Date(p.timestamp);
                    return createdAt >= date && createdAt < nextDate;
                }).length;
                
                counts.push(count);
            }

            const ctx = document.getElementById('dailyChart').getContext('2d');
            charts.daily = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Patients',
                        data: counts,
                        borderColor: '#0D9488',
                        backgroundColor: 'rgba(13, 148, 136, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: '#0D9488'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Severity Distribution Chart
        function createSeverityChart() {
            const counts = { 'mild': 0, 'moderate': 0, 'severe': 0 };

            allData.forEach(p => {
                const severity = (p.severity || 'moderate').toLowerCase();
                if (counts.hasOwnProperty(severity)) {
                    counts[severity]++;
                }
            });

            const ctx = document.getElementById('severityChart').getContext('2d');
            charts.severity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Mild', 'Moderate', 'Severe'],
                    datasets: [{
                        label: 'Count',
                        data: [counts['mild'], counts['moderate'], counts['severe']],
                        backgroundColor: ['#10B981', '#F59E0B', '#EF4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // Update recent activity
        function updateRecentActivity() {
            const activityDiv = document.getElementById('recent-activity');
            
            const recent = allData
                .sort((a, b) => {
                    const timeA = a.createdAt?.toDate() || new Date(a.timestamp);
                    const timeB = b.createdAt?.toDate() || new Date(b.timestamp);
                    return timeB - timeA;
                })
                .slice(0, 5);

            if (recent.length === 0) {
                activityDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No activity yet</p>';
                return;
            }

            activityDiv.innerHTML = recent.map(item => {
                const time = item.createdAt?.toDate() || new Date(item.timestamp);
                const timeStr = time.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                const colorClass = {
                    'EMERGENCY': 'bg-red-100 text-red-800',
                    'PHYSICIAN CONSULTATION': 'bg-yellow-100 text-yellow-800',
                    'NURSE CONSULTATION': 'bg-green-100 text-green-800',
                    'SELF-CARE': 'bg-blue-100 text-blue-800'
                }[item.triageLevel] || 'bg-gray-100 text-gray-800';

                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex items-center gap-4">
                            <div class="text-2xl">üë§</div>
                            <div>
                                <p class="font-semibold text-gray-800">${item.name || 'Unknown'}, ${item.age || '?'}</p>
                                <p class="text-sm text-gray-600">${(item.chiefComplaint || 'No complaint').substring(0, 60)}...</p>
                                ${item.location ? `<p class="text-xs text-gray-500">üìç ${item.location}</p>` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="${colorClass} px-3 py-1 rounded-full text-xs font-semibold">
                                ${(item.triageLevel || 'Unknown').substring(0, 20)}
                            </span>
                            <p class="text-xs text-gray-500 mt-1">${timeStr}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>